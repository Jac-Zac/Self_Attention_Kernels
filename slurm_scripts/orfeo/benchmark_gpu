#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=4
#SBATCH --mem=50G
#SBATCH --partition=GPU
#SBATCH --gres=gpu:V100:1
#SBATCH -t 00:15:00
#SBATCH --job-name=self_attention_gpu

echo "Running GPU benchmark on Orfeo with UV"

# 1. Ensure uv is in the PATH (standard install location)
export PATH="$HOME/.local/bin:$PATH"

# Install uv if it's missing (only happens once)
if ! command -v uv &> /dev/null; then
    echo "uv not found, installing..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    source $HOME/.cargo/env
fi

# 2. Load CUDA module for the kernel compilation
module load cuda

echo "Syncing dependencies..."
uv sync

# 3. Activate the environment created by uv
source .venv/bin/activate

echo "=== Starting GPU benchmark ==="
python -c "import torch; print(f'Using Device: {torch.cuda.get_device_name(0)}')"

# -------------------------------
# Benchmark configuration
# -------------------------------
BENCH_BATCH=4
BENCH_HEADS=8
BENCH_SEQLEN=2048
BENCH_HEADDIM=128
BENCH_SEED=1337
BENCH_WARMUP=5
BENCH_ITERS=25

# Create results directory
RESULTS_DIR="results"
mkdir -p "$RESULTS_DIR"

echo "=== Benchmark configuration ==="
echo "Backend     : cuda"
echo "Heads       : ${BENCH_HEADS}"
echo "Sequence len: ${BENCH_SEQLEN}"
echo "Head dim    : ${BENCH_HEADDIM}"
echo "Seed        : ${BENCH_SEED}"
echo "Warmup iters: ${BENCH_WARMUP}"
echo "Run iters   : ${BENCH_ITERS}"
echo "Output file : ${RESULTS_DIR}/benchmark_gpu.csv"
echo "================================"

# Run benchmark
make benchmark-cuda USE_SRUN=1 \
  BENCH_BATCH=${BENCH_BATCH} \
  BENCH_HEADS=${BENCH_HEADS} \
  BENCH_SEQLEN=${BENCH_SEQLEN} \
  BENCH_HEADDIM=${BENCH_HEADDIM} \
  BENCH_SEED=${BENCH_SEED} \
  BENCH_WARMUP=${BENCH_WARMUP} \
  BENCH_ITERS=${BENCH_ITERS} \
  BENCH_OUTPUT_FILE="$RESULTS_DIR/benchmark_gpu.csv"

echo ""
echo "=== GPU benchmark complete ==="
echo "Results: $RESULTS_DIR/benchmark_gpu.csv"
