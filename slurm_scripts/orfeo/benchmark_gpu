#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=4
#SBATCH --mem=50G
#SBATCH --partition=GPU
#SBATCH --gres=gpu:V100:1
#SBATCH -t 00:05:00
#SBATCH --job-name=self_attention_gpu

echo "Running GPU benchmark on Orfeo with UV"

# 1. Ensure uv is in the PATH (standard install location)
export PATH="$HOME/.local/bin:$PATH"

# Install uv if it's missing (only happens once)
if ! command -v uv &> /dev/null; then
    echo "uv not found, installing..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    source $HOME/.cargo/env
fi

# 2. Load CUDA module for the kernel compilation
module load cuda

echo "Syncing dependencies..."
# uv sync ensures the virtualenv (.venv) matches your pyproject.toml exactly
# It handles the Python installation, venv creation, and pip installs in one go.
uv sync

# 3. Activate the environment created by uv
source .venv/bin/activate

echo "=== Starting GPU benchmark ==="
# Check if torch sees the V100
python -c "import torch; print(f'Using Device: {torch.cuda.get_device_name(0)}')"

# Run benchmark
make benchmark BENCH_BACKEND=cuda USE_SRUN=1 \
  BENCH_BATCH=2 BENCH_HEADS=4 BENCH_SEQLEN=256 BENCH_HEADDIM=128 \
  BENCH_SEED=1337 BENCH_WARMUP=5 BENCH_ITERS=25
