#!/bin/bash
#SBATCH --nodes=1                   # 1 node
#SBATCH --ntasks=1                  # total MPI tasks across nodes
#SBATCH --ntasks-per-node=1         # 1 MPI task on the node
#SBATCH --cpus-per-task=24          # OpenMP threads per MPI task
#SBATCH --mem=0                     # use all available memory
##SBATCH --partition=EPYC
#SBATCH --partition=THIN
#SBATCH -t 00:20:00                 # 20 minutes
##SBATCH --exclusive                 # Get exclusive access to benchmark
#SBATCH --job-name=self_attention

# Set OpenMP environment variables
export OMP_PLACES=cores
export OMP_PROC_BIND=close

# Minimal Python venv + requirements
VENV_DIR="${VENV_DIR:-.venv}"
PY_BIN="${PY_BIN:-$(command -v python3 || command -v python)}"
if [ -z "$PY_BIN" ]; then
  echo "Python not found. Load a Python module." >&2
  exit 1
fi
[ -d "$VENV_DIR" ] || "$PY_BIN" -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"
pip install --upgrade pip -q

REQ_FILE="${REQ_FILE:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)/requirements.txt}"
[ -f "$REQ_FILE" ] || REQ_FILE="requirements.txt"
[ -f "$REQ_FILE" ] && pip install -r "$REQ_FILE" -q

# Create results directory
RESULTS_DIR="results"
mkdir -p "$RESULTS_DIR"

# Thread counts to benchmark
THREAD_COUNTS="1 2 8 12 18 24"

echo "=== Starting scaling benchmark ==="

# Run benchmarks for all thread counts (results appended to same CSV)
for threads in $THREAD_COUNTS; do
  echo ">>> $threads threads..."
  export OMP_NUM_THREADS=$threads
  make benchmark BENCH_BACKEND=multi BENCH_THREADS=$threads USE_SRUN=1 BENCH_OUTPUT_FILE="$RESULTS_DIR/benchmark_${threads}t.csv"
done

# Merge CSVs (keep header from first, skip headers from rest)
head -1 "$RESULTS_DIR/benchmark_1t.csv" > "$RESULTS_DIR/benchmark.csv"
for f in "$RESULTS_DIR"/benchmark_*t.csv; do
  tail -n +2 "$f" >> "$RESULTS_DIR/benchmark.csv"
done
rm -f "$RESULTS_DIR"/benchmark_*t.csv

echo ""
echo "=== Benchmark complete ==="
echo "Results: $RESULTS_DIR/benchmark.csv"
