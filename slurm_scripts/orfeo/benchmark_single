#!/bin/bash
#SBATCH --nodes=1                   # 1 node
#SBATCH --ntasks=1                  # total MPI tasks across nodes
#SBATCH --ntasks-per-node=1         # 1 MPI task on the node
#SBATCH --cpus-per-task=1           # Single thread for single-threaded benchmark
#SBATCH --mem=0                     # use all available memory
##SBATCH --partition=EPYC
#SBATCH --partition=GENOA
#SBATCH -t 00:30:00                 # 30 minutes (single-thread versions may take longer)
##SBATCH --exclusive                 # Get exclusive access to benchmark
#SBATCH --job-name=self_attention_single

echo "Running single-threaded benchmark on Orfeo"

# Minimal Python venv + requirements
VENV_DIR="${VENV_DIR:-.venv}"
PY_BIN="${PY_BIN:-$(command -v python3 || command -v python)}"
if [ -z "$PY_BIN" ]; then
  echo "Python not found. Load a Python module." >&2
  exit 1
fi
[ -d "$VENV_DIR" ] || "$PY_BIN" -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"
pip install --upgrade pip -q

REQ_FILE="${REQ_FILE:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)/requirements.txt}"
[ -f "$REQ_FILE" ] || REQ_FILE="requirements.txt"
[ -f "$REQ_FILE" ] && pip install -r "$REQ_FILE" -q

# Create results directory
RESULTS_DIR="results"
mkdir -p "$RESULTS_DIR"

echo "=== Starting single-threaded benchmark ==="
echo "Benchmarking all single-threaded kernel versions..."

# Run benchmark for single-threaded backend (all versions)
make benchmark BENCH_BACKEND=single BENCH_THREADS=1 USE_SRUN=1 \
  BENCH_BATCH=1 BENCH_HEADS=4 BENCH_SEQLEN=4096 BENCH_HEADDIM=128 \
  BENCH_SEED=1337 BENCH_WARMUP=5 BENCH_ITERS=25 \
  BENCH_OUTPUT_FILE="$RESULTS_DIR/benchmark_single.csv"

echo ""
echo "=== Single-threaded benchmark complete ==="
echo "Results: $RESULTS_DIR/benchmark_single.csv"
