#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=112
#SBATCH --mem=10G
#SBATCH --partition=dcgp_usr_prod
#SBATCH --exclusive                 # Get exclusive access for profiling
#SBATCH -A uTS25_Tornator_0
#SBATCH -t 00:15:00                 # 20 minutes for profiling
#SBATCH --job-name=self_attention_profile

# =======================================================
# Configurable parameters (override via environment)
# =======================================================
VERSION="${VERSION:-v0}"
BACKEND="${BACKEND:-multi}"
THREADS="${THREADS:-${SLURM_CPUS_PER_TASK}}"
BATCH="${BATCH:-8}"
N_HEADS="${N_HEADS:-32}"
SEQ_LEN="${SEQ_LEN:-2048}"
HEAD_DIM="${HEAD_DIM:-128}"

# =======================================================
# Load the required modules
# =======================================================
# module load openmpi/4.1.6--gcc--12.2.0
module load intel-oneapi-vtune/2024.1.0

# =======================================================
# Set OpenMP environment variables
# =======================================================
export OMP_NUM_THREADS=${THREADS}
export OMP_PLACES=cores
export OMP_PROC_BIND=close
export OMP_DISPLAY_AFFINITY=TRUE

# =======================================================
# Setup
# =======================================================
EXEC=./cmhsa.out
ARGS="--batch ${BATCH} --n_heads ${N_HEADS} --seq_len ${SEQ_LEN} --head_dim ${HEAD_DIM} --threads ${THREADS} --warmup 1 --iters 10"
RESULT_DIR="vtune_${BACKEND}_${VERSION}"

echo "=============================================="
echo "Profiling: ${BACKEND} ${VERSION} (${THREADS} threads)"
echo "Problem:   B=${BATCH} H=${N_HEADS} S=${SEQ_LEN} D=${HEAD_DIM}"
echo "=============================================="

# Build
echo ">>> Building..."
make ${BACKEND} VERSION=${VERSION} DEBUG=1

# VTune: Hotspots (identify where time is spent)
echo ">>> VTune hotspots..."
vtune -collect hotspots -result-dir ${RESULT_DIR}_hotspots \
      -- ${EXEC} ${ARGS}

# VTune: Microarchitecture Exploration
echo ">>> VTune uarch-exploration..."
vtune -collect uarch-exploration -result-dir ${RESULT_DIR}_uarch \
      -- ${EXEC} ${ARGS}

# VTune: Memory Access
echo ">>> VTune memory-access..."
vtune -collect memory-access -result-dir ${RESULT_DIR}_mem \
      -- ${EXEC} ${ARGS}

# VTune: Threading (detect load imbalance, contention)
echo ">>> VTune threading..."
vtune -collect threading -result-dir ${RESULT_DIR}_threading \
      -- ${EXEC} ${ARGS}

# Perf stat
echo ">>> Perf stat..."
perf stat -d -d \
  -e instructions,cycles,cache-references,cache-misses \
  -e dTLB-loads,dTLB-load-misses,iTLB-loads,iTLB-load-misses \
  -- ${EXEC} ${ARGS}

echo ""
echo "=== Done ==="
echo "VTune results: ${RESULT_DIR}_hotspots, ${RESULT_DIR}_uarch, ${RESULT_DIR}_mem, ${RESULT_DIR}_threading"
