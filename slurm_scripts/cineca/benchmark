#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=112
#SBATCH --mem=10G
#SBATCH --partition=dcgp_usr_prod
#SBATCH --exclusive
#SBATCH -A uTS25_Tornator_0
#SBATCH -t 00:10:00
#SBATCH --job-name=self_attention_bench

# Set OpenMP environment variables
export OMP_PLACES=cores
export OMP_PROC_BIND=close

echo "Running scaling benchmark on Cineca"
echo "Available CPUs: ${SLURM_CPUS_PER_TASK}"

source .venv/bin/activate

# Create results directory
RESULTS_DIR="results"
mkdir -p "$RESULTS_DIR"

# Thread counts to benchmark (scaled for 112 cores)
THREAD_COUNTS="1 2 4 8 16 28 56 112"

echo "=== Starting scaling benchmark ==="

# Run benchmarks for all thread counts
for threads in $THREAD_COUNTS; do
  echo ">>> $threads threads..."
  export OMP_NUM_THREADS=$threads
  make benchmark-multi USE_SRUN=1 BENCH_THREADS=$threads BENCH_OUTPUT_FILE="$RESULTS_DIR/benchmark_${threads}t.csv"
done

# Merge CSVs (keep header from first, skip headers from rest)
head -1 "$RESULTS_DIR/benchmark_1t.csv" > "$RESULTS_DIR/benchmark.csv"
for f in "$RESULTS_DIR"/benchmark_*t.csv; do
  tail -n +2 "$f" >> "$RESULTS_DIR/benchmark.csv"
done
rm -f "$RESULTS_DIR"/benchmark_*t.csv

echo ""
echo "=== Benchmark complete ==="
echo "Results: $RESULTS_DIR/benchmark.csv"
